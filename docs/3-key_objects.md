# Key Objects

[_Documentation generated by Documatic_](https://www.documatic.com)

<!---Documatic-section-yarAnalyzer.walk_error-start--->
## yarAnalyzer.walk_error

<!---Documatic-section-walk_error-start--->
<!---Documatic-block-yarAnalyzer.walk_error-start--->
<details>
	<summary><code>yarAnalyzer.walk_error</code> code snippet</summary>

```python
def walk_error(err):
    if 'Error 3' in str(err):
        log('ERROR', str(err))
    if args.debug:
        traceback.print_exc()
```
</details>
<!---Documatic-block-yarAnalyzer.walk_error-end--->
<!---Documatic-section-walk_error-end--->

# #
<!---Documatic-section-yarAnalyzer.walk_error-end--->

<!---Documatic-section-yarAnalyzer.generate_hashes-start--->
## yarAnalyzer.generate_hashes

<!---Documatic-section-generate_hashes-start--->
<!---Documatic-block-yarAnalyzer.generate_hashes-start--->
<details>
	<summary><code>yarAnalyzer.generate_hashes</code> code snippet</summary>

```python
def generate_hashes(filedata):
    try:
        md5 = hashlib.md5()
        sha1 = hashlib.sha1()
        sha256 = hashlib.sha256()
        md5.update(filedata)
        sha1.update(filedata)
        sha256.update(filedata)
        return (md5.hexdigest(), sha1.hexdigest(), sha256.hexdigest())
    except Exception as e:
        traceback.print_exc()
        return (0, 0, 0)
```
</details>
<!---Documatic-block-yarAnalyzer.generate_hashes-end--->
<!---Documatic-section-generate_hashes-end--->

# #
<!---Documatic-section-yarAnalyzer.generate_hashes-end--->

<!---Documatic-section-yarAnalyzer.remove_non_ascii-start--->
## yarAnalyzer.remove_non_ascii

<!---Documatic-section-remove_non_ascii-start--->
<!---Documatic-block-yarAnalyzer.remove_non_ascii-start--->
<details>
	<summary><code>yarAnalyzer.remove_non_ascii</code> code snippet</summary>

```python
def remove_non_ascii(s):
    nonascii = 'error'
    try:
        new_bytes = []
        for cb in s:
            if cb > 31 and cb < 127:
                new_bytes.append(chr(cb))
            else:
                new_bytes.append(chr(32))
        nonascii = ''.join(new_bytes)
    except Exception as e:
        traceback.print_exc()
        pass
    return nonascii
```
</details>
<!---Documatic-block-yarAnalyzer.remove_non_ascii-end--->
<!---Documatic-section-remove_non_ascii-end--->

# #
<!---Documatic-section-yarAnalyzer.remove_non_ascii-end--->

<!---Documatic-section-yarAnalyzer.save_stats-start--->
## yarAnalyzer.save_stats

<!---Documatic-section-save_stats-start--->
<!---Documatic-block-yarAnalyzer.save_stats-start--->
<details>
	<summary><code>yarAnalyzer.save_stats</code> code snippet</summary>

```python
def save_stats(no_empty=False, identifier='yarAnalyzer', excel_patch=False):
    with open('{0}_file_stats.csv'.format(identifier), 'w') as f_file:
        f_file.write('File;Extension;Size;First Bytes in Hex;First Bytes in ASCII;MD5;SHA1;SHA256;Rule Match;Matched Strings\n')
        for relPath in file_stats:
            if no_empty and len(file_stats[relPath]['matches']) < 1:
                continue
            extension = os.path.splitext(relPath)[1].lower()
            excel_addon = '=' if excel_patch else ''
            try:
                if len(file_stats[relPath]['matches']) > 0:
                    for rule in file_stats[relPath]['matches']:
                        matched_strings = file_stats[relPath]['matches'][rule]
                        f_file.write('{0};{1};{2};{10}"{3}";{10}"{4}";{5};{6};{7};{8};{10}"{9}"\n'.format(relPath, extension, file_stats[relPath]['size'], file_stats[relPath]['firstBytes_Hex'], file_stats[relPath]['firstBytes_Ascii'], file_stats[relPath]['md5'], file_stats[relPath]['sha1'], file_stats[relPath]['sha256'], rule, matched_strings, excel_addon))
                else:
                    f_file.write('{0};{1};{2};{10}"{3}";{10}"{4}";{5};{6};{7};{8};{10}"{9}"\n'.format(relPath, extension, file_stats[relPath]['size'], file_stats[relPath]['firstBytes_Hex'], file_stats[relPath]['firstBytes_Ascii'], file_stats[relPath]['md5'], file_stats[relPath]['sha1'], file_stats[relPath]['sha256'], '-', '-', excel_addon))
                    if args.t:
                        source_file = os.path.join(args.p, relPath)
                        target_file = os.path.join(args.t, os.path.basename(relPath))
                        print('[+] Copying sample with no match to {0}'.format(target_file))
                        shutil.copyfile(source_file, target_file)
            except Exception as e:
                if args.debug:
                    traceback.print_exc()
                print('Error while formatting line - skipping it - CSV results may be incomplete')
    with open('{0}_rule_stats.csv'.format(identifier), 'w') as r_file:
        r_file.write('Rule;Number of Matches;File;MD5;SHA1;SHA256\n')
        for rule in rule_stats:
            if no_empty and len(rule_stats[rule]['files']) < 1:
                continue
            try:
                if len(rule_stats[rule]['files']) > 0:
                    for file in rule_stats[rule]['files']:
                        r_file.write('{0};{1};{2};{3};{4};{5}\n'.format(rule, len(rule_stats[rule]['files']), file, file_stats[file]['md5'], file_stats[file]['sha1'], file_stats[file]['sha256']))
                else:
                    r_file.write('{0};{1};{2};{3};{4};{5}\n'.format(rule, len(rule_stats[rule]['files']), '-', '-', '-', '-'))
            except Exception as e:
                print('Error while formatting line - skipping it - CSV results may be incomplete')
```
</details>
<!---Documatic-block-yarAnalyzer.save_stats-end--->
<!---Documatic-section-save_stats-end--->

# #
<!---Documatic-section-yarAnalyzer.save_stats-end--->

<!---Documatic-section-yarAnalyzer.pretty_print-start--->
## yarAnalyzer.pretty_print

<!---Documatic-section-pretty_print-start--->
<!---Documatic-block-yarAnalyzer.pretty_print-start--->
<details>
	<summary><code>yarAnalyzer.pretty_print</code> code snippet</summary>

```python
def pretty_print(no_empty=False, max_string=26):
    x = PrettyTable(['File', 'Size', 'HHex', 'HAscii', 'Rule Matches'])
    x.padding_width = 1
    x.align['File'] = 'l'
    x.align['Size'] = 'l'
    x.align['HAscii'] = 'l'
    x.align['HHex'] = 'l'
    x.align['Rule Matches'] = 'l'
    for relPath in file_stats:
        if no_empty and len(file_stats[relPath]['matches']) < 1:
            continue
        rules = '\n'.join((rule[:max_string] for rule in file_stats[relPath]['matches']))
        x.add_row([relPath[:max_string], file_stats[relPath]['size'], file_stats[relPath]['firstBytes_Hex'], file_stats[relPath]['firstBytes_Ascii'], rules])
    print(x)
    x = PrettyTable(['Rule', 'Match Count', 'Files'])
    x.padding_width = 1
    x.align['Rule'] = 'l'
    x.align['Match Count'] = 'l'
    x.align['Files'] = 'l'
    for rule in rule_stats:
        if no_empty and len(rule_stats[rule]['files']) < 1:
            continue
        rule_name = rule[:max_string]
        files = '\n'.join((file[:max_string] for file in rule_stats[rule]['files']))
        x.add_row([rule_name, len(rule_stats[rule]['files']), files])
    print(x)
```
</details>
<!---Documatic-block-yarAnalyzer.pretty_print-end--->
<!---Documatic-section-pretty_print-end--->

# #
<!---Documatic-section-yarAnalyzer.pretty_print-end--->

<!---Documatic-section-yarAnalyzer.get_application_path-start--->
## yarAnalyzer.get_application_path

<!---Documatic-section-get_application_path-start--->
<!---Documatic-block-yarAnalyzer.get_application_path-start--->
<details>
	<summary><code>yarAnalyzer.get_application_path</code> code snippet</summary>

```python
def get_application_path():
    try:
        application_path = ''
        if getattr(sys, 'frozen', False):
            application_path = os.path.dirname(os.path.realpath(sys.executable))
        elif __file__:
            application_path = os.path.dirname(__file__)
        if application_path != '':
            pass
        if application_path == '':
            application_path = os.path.dirname(os.path.realpath(__file__))
        return application_path
    except Exception as e:
        log('ERROR', 'Error while evaluation of application path')
```
</details>
<!---Documatic-block-yarAnalyzer.get_application_path-end--->
<!---Documatic-section-get_application_path-end--->

# #
<!---Documatic-section-yarAnalyzer.get_application_path-end--->

<!---Documatic-section-yarAnalyzer.generate_yara_stats_structure-start--->
## yarAnalyzer.generate_yara_stats_structure

<!---Documatic-section-generate_yara_stats_structure-start--->
<!---Documatic-block-yarAnalyzer.generate_yara_stats_structure-start--->
<details>
	<summary><code>yarAnalyzer.generate_yara_stats_structure</code> code snippet</summary>

```python
def generate_yara_stats_structure(yara_rules):
    for rule_set in yara_rules:
        for rule in rule_set:
            rule_stats[rule.identifier] = {}
            rule_stats[rule.identifier]['files'] = []
            rule_stats[rule.identifier]['count'] = 0
```
</details>
<!---Documatic-block-yarAnalyzer.generate_yara_stats_structure-end--->
<!---Documatic-section-generate_yara_stats_structure-end--->

# #
<!---Documatic-section-yarAnalyzer.generate_yara_stats_structure-end--->

<!---Documatic-section-yarAnalyzer.generate_yara_inventory-start--->
## yarAnalyzer.generate_yara_inventory

<!---Documatic-section-generate_yara_inventory-start--->
<!---Documatic-block-yarAnalyzer.generate_yara_inventory-start--->
<details>
	<summary><code>yarAnalyzer.generate_yara_inventory</code> code snippet</summary>

```python
def generate_yara_inventory(output_file, yara_rule_infos):
    log('INFO', 'Generating Inventory')
    try:
        with open(output_file, 'w') as output:
            output.write('Rule File;Rule Name;Description;Reference;Compile Issue\n')
            for rule_file in yara_rule_infos:
                for rule_name in yara_rule_infos[rule_file]:
                    description = '-'
                    reference = '-'
                    if 'description' in yara_rule_infos[rule_file][rule_name]:
                        description = yara_rule_infos[rule_file][rule_name]['description']
                    if 'reference' in yara_rule_infos[rule_file][rule_name]:
                        reference = yara_rule_infos[rule_file][rule_name]['reference']
                    description = description.replace('; ', ' / ').replace(';', ' ')
                    reference = reference.replace('; ', ' / ').replace(';', ' ')
                    output.write('{0};{1};{2};{3};\n'.format(rule_file, rule_name, description, reference))
    except Exception as e:
        traceback.print_exc()
```
</details>
<!---Documatic-block-yarAnalyzer.generate_yara_inventory-end--->
<!---Documatic-section-generate_yara_inventory-end--->

# #
<!---Documatic-section-yarAnalyzer.generate_yara_inventory-end--->

<!---Documatic-section-yarAnalyzer.initialize_yara_rules-start--->
## yarAnalyzer.initialize_yara_rules

<!---Documatic-section-initialize_yara_rules-start--->
<!---Documatic-block-yarAnalyzer.initialize_yara_rules-start--->
<details>
	<summary><code>yarAnalyzer.initialize_yara_rules</code> code snippet</summary>

```python
def initialize_yara_rules(rule_path, rules_extension):
    yara_rule_infos = {}
    yara_rules = []
    dummy = ''
    if os.path.isdir(rule_path):
        try:
            for (root, directories, files) in scandir.walk(rule_path, onerror=walk_error, followlinks=False):
                for file in files:
                    try:
                        yaraRuleFile = os.path.join(root, file)
                        if file.startswith('.') or file.startswith('~') or file.startswith('_'):
                            continue
                        extension = os.path.splitext(file)[1].lower()
                        if extension == '.{0}'.format(rules_extension):
                            try:
                                compiledRules = yara.compile(yaraRuleFile, externals={'filename': dummy, 'filepath': dummy, 'extension': dummy, 'filetype': dummy, 'id': dummy, 'md5': dummy})
                                for rule in compiledRules:
                                    if file not in yara_rule_infos:
                                        yara_rule_infos[file] = {}
                                    if rule.identifier not in yara_rule_infos[file]:
                                        yara_rule_infos[file][rule.identifier] = {}
                                    if 'description' in rule.meta:
                                        yara_rule_infos[file][rule.identifier]['description'] = rule.meta['description']
                                    if 'reference' in rule.meta:
                                        yara_rule_infos[file][rule.identifier]['reference'] = rule.meta['reference']
                                yara_rules.append(compiledRules)
                                log('INFO', 'Initialized Yara rules from %s' % file)
                            except Exception as e:
                                log('ERROR', 'Error in Yara file: %s' % file)
                                if args.debug:
                                    traceback.print_exc()
                    except Exception as e:
                        log('ERROR', 'Error reading signature file %s ERROR: %s' % yaraRuleFile)
                        if args.debug:
                            traceback.print_exc()
        except Exception as e:
            log('ERROR', 'Error reading signature folder /signatures/')
            if args.debug:
                traceback.print_exc()
    else:
        try:
            compiledRules = yara.compile(rule_path, externals={'filename': dummy, 'filepath': dummy})
            yara_rules.append(compiledRules)
            log('INFO', 'Initialized Yara rules from %s' % rule_path)
        except Exception as e:
            log('ERROR', 'Error in Yara file: %s' % rule_path)
            if args.debug:
                traceback.print_exc()
    return (yara_rules, yara_rule_infos)
```
</details>
<!---Documatic-block-yarAnalyzer.initialize_yara_rules-end--->
<!---Documatic-section-initialize_yara_rules-end--->

# #
<!---Documatic-section-yarAnalyzer.initialize_yara_rules-end--->

<!---Documatic-section-yarAnalyzer.scan_path-start--->
## yarAnalyzer.scan_path

<!---Documatic-section-scan_path-start--->
<!---Documatic-block-yarAnalyzer.scan_path-start--->
<details>
	<summary><code>yarAnalyzer.scan_path</code> code snippet</summary>

```python
def scan_path(path, rule_sets, num_first_bytes=6):
    log('INFO', 'Scanning %s ...  ' % path)
    c = 0
    app_path = get_application_path()
    for (root, directories, files) in scandir.walk(path, onerror=walk_error, followlinks=False):
        for filename in files:
            try:
                filePath = os.path.join(root, filename)
                relPath = filePath[len(path):]
                fileSize = os.stat(filePath).st_size
                if fileSize > args.m * 1024 * 1024:
                    continue
                file_stats[relPath] = {}
                file_stats[relPath]['matches'] = {}
                file_stats[relPath]['size'] = fileSize
                fileData = ''
                md5 = '-'
                sha1 = '-'
                sha256 = '-'
                fileData = read_file_data(filePath)
                if len(fileData) > 1:
                    file_stats[relPath]['firstBytes_Hex'] = '%s' % fileData[:num_first_bytes].hex()
                    file_stats[relPath]['firstBytes_Ascii'] = '%s' % remove_non_ascii(fileData[:num_first_bytes])
                else:
                    file_stats[relPath]['firstBytes_Hex'] = '-'
                    file_stats[relPath]['firstBytes_Ascii'] = '-'
                (md5, sha1, sha256) = generate_hashes(fileData)
                file_stats[relPath]['md5'] = md5
                file_stats[relPath]['sha1'] = sha1
                file_stats[relPath]['sha256'] = sha256
                log('DEBUG', 'MD5: %s SHA1: %s SHA256: %s FILE: %s' % (md5, sha1, sha256, filePath))
                if args.printAll:
                    print('FILE: %s' % filePath)
                try:
                    for rules in rule_sets:
                        matches = rules.match(data=fileData, externals={'filename': filename.lower(), 'filepath': filePath.lower()})
                        if matches:
                            for match in matches:
                                description = 'not set'
                                if hasattr(match, 'meta'):
                                    if 'description' in match.meta:
                                        description = match.meta['description']
                                matched_strings = ''
                                if hasattr(match, 'strings'):
                                    matched_strings = get_string_matches(match.strings)
                                if relPath not in file_stats:
                                    file_stats[relPath] = {}
                                if 'matches' not in file_stats[relPath]:
                                    file_stats[relPath]['matches'] = {}
                                file_stats[relPath]['matches'][match.rule] = matched_strings
                                if match.rule not in rule_stats:
                                    rule_stats[match.rule] = {}
                                if 'files' not in rule_stats[match.rule]:
                                    rule_stats[match.rule]['files'] = []
                                rule_stats[match.rule]['files'].append(relPath)
                except Exception as e:
                    if args.debug:
                        traceback.print_exc()
            except Exception as e:
                if args.debug:
                    traceback.print_exc()
```
</details>
<!---Documatic-block-yarAnalyzer.scan_path-end--->
<!---Documatic-section-scan_path-end--->

# #
<!---Documatic-section-yarAnalyzer.scan_path-end--->

<!---Documatic-section-yarAnalyzer.get_platform_full-start--->
## yarAnalyzer.get_platform_full

<!---Documatic-section-get_platform_full-start--->
<!---Documatic-block-yarAnalyzer.get_platform_full-start--->
<details>
	<summary><code>yarAnalyzer.get_platform_full</code> code snippet</summary>

```python
def get_platform_full():
    type_info = ''
    try:
        type_info = '%s PROC: %s ARCH: %s' % (' '.join(platform.win32_ver()), platform.processor(), ' '.join(platform.architecture()))
    except Exception as e:
        type_info = ' '.join(platform.win32_ver())
    return type_info
```
</details>
<!---Documatic-block-yarAnalyzer.get_platform_full-end--->
<!---Documatic-section-get_platform_full-end--->

# #
<!---Documatic-section-yarAnalyzer.get_platform_full-end--->

<!---Documatic-section-yarAnalyzer.print_welcome-start--->
## yarAnalyzer.print_welcome

<!---Documatic-section-print_welcome-start--->
<!---Documatic-block-yarAnalyzer.print_welcome-start--->
<details>
	<summary><code>yarAnalyzer.print_welcome</code> code snippet</summary>

```python
def print_welcome():
    print('=======================================================================')
    print('                       ___                __                      ')
    print('     __  ______ ______/   |  ____  ____ _/ /_  ______  ___  _____ ')
    print('    / / / / __ `/ ___/ /| | / __ \\/ __ `/ / / / /_  / / _ \\/ ___/ ')
    print('   / /_/ / /_/ / /  / ___ |/ / / / /_/ / / /_/ / / /_/  __/ /     ')
    print('   \\__, /\\__,_/_/  /_/  |_/_/ /_/\\__,_/_/\\__, / /___/\\___/_/      ')
    print('  /____/                                /____/                    ')
    print('  ')
    print('  by Florian Roth')
    print('  November 2019')
    print('  Version %s' % __version__)
    print('  ')
    print('=======================================================================')
    print('  ')
```
</details>
<!---Documatic-block-yarAnalyzer.print_welcome-end--->
<!---Documatic-section-print_welcome-end--->

# #
<!---Documatic-section-yarAnalyzer.print_welcome-end--->

<!---Documatic-section-yarAnalyzer.remove_binary_zero-start--->
## yarAnalyzer.remove_binary_zero

<!---Documatic-section-remove_binary_zero-start--->
<!---Documatic-block-yarAnalyzer.remove_binary_zero-start--->
<details>
	<summary><code>yarAnalyzer.remove_binary_zero</code> code snippet</summary>

```python
def remove_binary_zero(s):
    new_bytes = []
    for cb in s:
        if cb != 0:
            new_bytes.append(chr(cb))
        else:
            new_bytes.append(chr(32))
    return ''.join(new_bytes)
```
</details>
<!---Documatic-block-yarAnalyzer.remove_binary_zero-end--->
<!---Documatic-section-remove_binary_zero-end--->

# #
<!---Documatic-section-yarAnalyzer.remove_binary_zero-end--->

<!---Documatic-section-yarAnalyzer.read_file_data-start--->
## yarAnalyzer.read_file_data

<!---Documatic-section-read_file_data-start--->
<!---Documatic-block-yarAnalyzer.read_file_data-start--->
<details>
	<summary><code>yarAnalyzer.read_file_data</code> code snippet</summary>

```python
def read_file_data(filePath):
    fileData = ''
    try:
        with open(filePath, 'rb') as f:
            fileData = f.read()
    except Exception as e:
        log('DEBUG', 'Cannot open file %s (access denied)' % filePath)
    finally:
        return fileData
```
</details>
<!---Documatic-block-yarAnalyzer.read_file_data-end--->
<!---Documatic-section-read_file_data-end--->

# #
<!---Documatic-section-yarAnalyzer.read_file_data-end--->

<!---Documatic-section-yarAnalyzer.log-start--->
## yarAnalyzer.log

<!---Documatic-section-log-start--->
<!---Documatic-block-yarAnalyzer.log-start--->
<details>
	<summary><code>yarAnalyzer.log</code> code snippet</summary>

```python
def log(mes_type, message):
    if not args.debug and mes_type == 'DEBUG':
        return
    print('[%s]: %s' % (mes_type, message))
```
</details>
<!---Documatic-block-yarAnalyzer.log-end--->
<!---Documatic-section-log-end--->

# #
<!---Documatic-section-yarAnalyzer.log-end--->

<!---Documatic-section-yarAnalyzer.get_string_matches-start--->
## yarAnalyzer.get_string_matches

<!---Documatic-section-get_string_matches-start--->
<!---Documatic-block-yarAnalyzer.get_string_matches-start--->
<details>
	<summary><code>yarAnalyzer.get_string_matches</code> code snippet</summary>

```python
def get_string_matches(strings):
    try:
        string_matches = []
        matching_strings = ''
        for string in strings:
            extract = string[2]
            if not extract in string_matches:
                string_matches.append(extract)
        string_num = 1
        for string in string_matches:
            if b'\x00' in string:
                matching_strings += ' Str' + str(string_num) + '(U): ' + remove_binary_zero(string)
            else:
                matching_strings += ' Str' + str(string_num) + '(A): ' + remove_binary_zero(string)
            string_num += 1
        if len(matching_strings) > 140:
            matching_strings = matching_strings[:140] + ' ... (truncated)'
        return matching_strings.lstrip(' ')
    except:
        traceback.print_exc()
```
</details>
<!---Documatic-block-yarAnalyzer.get_string_matches-end--->
<!---Documatic-section-get_string_matches-end--->

# #
<!---Documatic-section-yarAnalyzer.get_string_matches-end--->

[_Documentation generated by Documatic_](https://www.documatic.com)